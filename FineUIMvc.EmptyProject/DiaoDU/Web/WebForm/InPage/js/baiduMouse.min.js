var BMapLib=window.BMapLib=BMapLib||{},BMAP_DRAWING_MARKER="marker",BMAP_DRAWING_POLYLINE="polyline",BMAP_DRAWING_CIRCLE="circle",BMAP_DRAWING_RECTANGLE="rectangle",BMAP_DRAWING_POLYGON="polygon";!function(){function t(){this._enableEdgeMove=!1}function e(t,e){this.drawingManager=t,e=this.drawingToolOptions=e||{},this.defaultAnchor=BMAP_ANCHOR_TOP_LEFT,this.defaultOffset=new BMap.Size(10,10),this.defaultDrawingModes=[BMAP_DRAWING_POLYLINE,BMAP_DRAWING_MARKER,BMAP_DRAWING_MARKER,BMAP_DRAWING_MARKER,BMAP_DRAWING_MARKER,BMAP_DRAWING_MARKER,BMAP_DRAWING_MARKER,BMAP_DRAWING_MARKER],this.drawingModes=e.drawingModes?e.drawingModes:this.defaultDrawingModes,e.anchor&&this.setAnchor(e.anchor),e.offset&&this.setOffset(e.offset)}function n(t){for(var e=a.length;e--;)a[e]!=t&&a[e].close()}var i=i||{guid:"$BAIDU$"};!function(){window[i.guid]={},i.extend=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},i.lang=i.lang||{},i.lang.guid=function(){return"TANGRAM__"+(window[i.guid]._counter++).toString(36)},window[i.guid]._counter=window[i.guid]._counter||1,window[i.guid]._instances=window[i.guid]._instances||{},i.lang.Class=function(t){this.guid=t||i.lang.guid(),window[i.guid]._instances[this.guid]=this},window[i.guid]._instances=window[i.guid]._instances||{},i.lang.isString=function(t){return"[object String]"==Object.prototype.toString.call(t)},i.lang.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},i.lang.Class.prototype.toString=function(){return"[object "+(this._className||"Object")+"]"},i.lang.Class.prototype.dispose=function(){delete window[i.guid]._instances[this.guid];for(var t in this)i.lang.isFunction(this[t])||delete this[t];this.disposed=!0},i.lang.Event=function(t,e){this.type=t,this.returnValue=!0,this.target=e||null,this.currentTarget=null},i.lang.Class.prototype.addEventListener=function(t,e,n){if(i.lang.isFunction(e)){!this.__listeners&&(this.__listeners={});var o,a=this.__listeners;if("string"==typeof n&&n){if(/[^\w\-]/.test(n))throw"nonstandard key:"+n;e.hashCode=n,o=n}0!=t.indexOf("on")&&(t="on"+t),"object"!=typeof a[t]&&(a[t]={}),o=o||i.lang.guid(),e.hashCode=o,a[t][o]=e}},i.lang.Class.prototype.removeEventListener=function(t,e){if(i.lang.isFunction(e))e=e.hashCode;else if(!i.lang.isString(e))return;!this.__listeners&&(this.__listeners={}),0!=t.indexOf("on")&&(t="on"+t);var n=this.__listeners;n[t]&&n[t][e]&&delete n[t][e]},i.lang.Class.prototype.dispatchEvent=function(t,e){i.lang.isString(t)&&(t=new i.lang.Event(t)),!this.__listeners&&(this.__listeners={}),e=e||{};for(var n in e)t[n]=e[n];var n,o=this.__listeners,a=t.type;if(t.target=t.target||this,t.currentTarget=this,0!=a.indexOf("on")&&(a="on"+a),i.lang.isFunction(this[a])&&this[a].apply(this,arguments),"object"==typeof o[a])for(n in o[a])o[a][n].apply(this,arguments);return t.returnValue},i.lang.inherits=function(t,e,n){var i,o,a=t.prototype,r=new Function;r.prototype=e.prototype,o=t.prototype=new r;for(i in a)o[i]=a[i];t.prototype.constructor=t,t.superClass=e.prototype,"string"==typeof n&&(o._className=n)},i.dom=i.dom||{},i._g=i.dom._g=function(t){return i.lang.isString(t)?document.getElementById(t):t},i.g=i.dom.g=function(t){return"string"==typeof t||t instanceof String?document.getElementById(t):t&&t.nodeName&&(1==t.nodeType||9==t.nodeType)?t:null},i.insertHTML=i.dom.insertHTML=function(t,e,n){t=i.dom.g(t);var o,a;return t.insertAdjacentHTML?t.insertAdjacentHTML(e,n):(o=t.ownerDocument.createRange(),e=e.toUpperCase(),"AFTERBEGIN"==e||"BEFOREEND"==e?(o.selectNodeContents(t),o.collapse("AFTERBEGIN"==e)):(a="BEFOREBEGIN"==e,o[a?"setStartBefore":"setEndAfter"](t),o.collapse(a)),o.insertNode(o.createContextualFragment(n))),t},i.ac=i.dom.addClass=function(t,e){t=i.dom.g(t);for(var n=e.split(/\s+/),o=t.className,a=" "+o+" ",r=0,s=n.length;s>r;r++)a.indexOf(" "+n[r]+" ")<0&&(o+=(o?" ":"")+n[r]);return t.className=o,t},i.event=i.event||{},i.event._listeners=i.event._listeners||[],i.on=i.event.on=function(t,e,n){e=e.replace(/^on/i,""),t=i._g(t);var o,a=function(e){n.call(t,e)},r=i.event._listeners,s=i.event._eventFilter,l=e;return e=e.toLowerCase(),s&&s[e]&&(o=s[e](t,e,a),l=o.type,a=o.listener),t.addEventListener?t.addEventListener(l,a,!1):t.attachEvent&&t.attachEvent("on"+l,a),r[r.length]=[t,e,n,a,l],t},i.un=i.event.un=function(t,e,n){t=i._g(t),e=e.replace(/^on/i,"").toLowerCase();for(var o,a,r,s=i.event._listeners,l=s.length,p=!n;l--;)o=s[l],o[1]!==e||o[0]!==t||!p&&o[2]!==n||(a=o[4],r=o[3],t.removeEventListener?t.removeEventListener(a,r,!1):t.detachEvent&&t.detachEvent("on"+a,r),s.splice(l,1));return t},i.getEvent=i.event.getEvent=function(t){return window.event||t},i.getTarget=i.event.getTarget=function(t){var t=i.getEvent(t);return t.target||t.srcElement},i.preventDefault=i.event.preventDefault=function(t){var t=i.getEvent(t);t.preventDefault?t.preventDefault():t.returnValue=!1},i.stopBubble=i.event.stopBubble=function(t){t=i.getEvent(t),t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},i.browser=i.browser||{},/msie (\d+\.\d)/i.test(navigator.userAgent)&&(i.browser.ie=i.ie=document.documentMode||+RegExp.$1)}();var o=BMapLib.DrawingManager=function(t,e){t&&(a.push(this),e=e||{},this._initialize(t,e))};i.lang.inherits(o,i.lang.Class,"DrawingManager"),o.prototype.open=function(){return 1==this._isOpen?!0:(n(this),void this._open())},o.prototype.close=function(){if(0==this._isOpen)return!0;var t=this;this._close(),setTimeout(function(){t._map.enableDoubleClickZoom()},2e3)},o.prototype.setDrawingMode=function(t){this._drawingType!=t&&(n(this),this._setDrawingMode(t))},o.prototype.getDrawingMode=function(){return this._drawingType},o.prototype.enableCalculate=function(){this._enableCalculate=!0,this._addGeoUtilsLibrary()},o.prototype.disableCalculate=function(){this._enableCalculate=!1},o.prototype._initialize=function(t,n){if(this._map=t,this._opts=n,this._drawingType=n.drawingMode||BMAP_DRAWING_MARKER,n.enableDrawingTool){var i=new e(this,n.drawingToolOptions);this._drawingTool=i,t.addControl(i)}n.enableCalculate===!0?this.enableCalculate():this.disableCalculate(),this._isOpen=!(n.isOpen!==!0),this._isOpen&&this._open(),this.markerOptions=n.markerOptions||{},this.circleOptions=n.circleOptions||{},this.polylineOptions=n.polylineOptions||{},this.polygonOptions=n.polygonOptions||{},this.rectangleOptions=n.rectangleOptions||{},this.controlButton="right"==n.controlButton?"right":"left"},o.prototype._open=function(){this._isOpen=!0,this._mask||(this._mask=new t),this._map.addOverlay(this._mask),this._setDrawingMode(this._drawingType)},o.prototype._setDrawingMode=function(t){if(this._drawingType=t,this._isOpen)switch(this._mask.__listeners={},t){case BMAP_DRAWING_MARKER:this._bindMarker();break;case BMAP_DRAWING_CIRCLE:this._bindCircle();break;case BMAP_DRAWING_POLYLINE:case BMAP_DRAWING_POLYGON:this._bindPolylineOrPolygon();break;case BMAP_DRAWING_RECTANGLE:this._bindRectangle()}this._drawingTool&&this._isOpen&&this._drawingTool.setStyleByDrawingMode(t)},o.prototype._close=function(){this._isOpen=!1,this._mask&&this._map.removeOverlay(this._mask),this._drawingTool&&this._drawingTool.setStyleByDrawingMode("hander")},o.prototype._bindMarker=function(){var t=this,e=this._map,n=this._mask,i=function(n){var i=new BMap.Marker(n.point,t.markerOptions);e.addOverlay(i),t._dispatchOverlayComplete(i)};n.addEventListener("click",i)},o.prototype._bindCircle=function(){var t=this,e=this._map,n=this._mask,o=null,a=null,r=function(r){("right"!=t.controlButton||1!=r.button&&0!=r.button)&&(a=r.point,o=new BMap.Circle(a,0,t.circleOptions),e.addOverlay(o),n.enableEdgeMove(),n.addEventListener("mousemove",s),i.on(document,"mouseup",l))},s=function(e){o.setRadius(t._map.getDistance(a,e.point))},l=function(e){var r=t._calculate(o,e.point);t._dispatchOverlayComplete(o,r),a=null,n.disableEdgeMove(),n.removeEventListener("mousemove",s),i.un(document,"mouseup",l)},p=function(e){i.preventDefault(e),i.stopBubble(e),("right"!=t.controlButton||1!=e.button)&&null==a&&r(e)};n.addEventListener("mousedown",p)},o.prototype._bindPolylineOrPolygon=function(){var t=this,e=this._map,n=this._mask,o=[],a=null;overlay=null,isBinded=!1;var r=function(i){("right"!=t.controlButton||1!=i.button&&0!=i.button)&&(o.push(i.point),a=o.concat(o[o.length-1]),1==o.length?(t._drawingType==BMAP_DRAWING_POLYLINE?overlay=new BMap.Polyline(a,t.polylineOptions):t._drawingType==BMAP_DRAWING_POLYGON&&(overlay=new BMap.Polygon(a,t.polygonOptions)),e.addOverlay(overlay)):overlay.setPath(a),isBinded||(isBinded=!0,n.enableEdgeMove(),n.addEventListener("mousemove",s),n.addEventListener("dblclick",l)))},s=function(t){overlay.setPositionAt(a.length-1,t.point)},l=function(e){i.stopBubble(e),isBinded=!1,n.disableEdgeMove(),n.removeEventListener("mousedown",r),n.removeEventListener("mousemove",s),n.removeEventListener("dblclick",l),"right"==t.controlButton?o.push(e.point):i.ie<=8||o.pop(),overlay.setPath(o);var p=t._calculate(overlay,o.pop());t._dispatchOverlayComplete(overlay,p),o.length=0,a.length=0,t.close()};n.addEventListener("mousedown",r),n.addEventListener("dblclick",function(t){i.stopBubble(t)})},o.prototype._bindRectangle=function(){var t=this,e=this._map,n=this._mask,o=null,a=null,r=function(r){if(i.stopBubble(r),i.preventDefault(r),"right"!=t.controlButton||1!=r.button&&0!=r.button){a=r.point;var p=a;o=new BMap.Polygon(t._getRectanglePoint(a,p),t.rectangleOptions),e.addOverlay(o),n.enableEdgeMove(),n.addEventListener("mousemove",s),i.on(document,"mouseup",l)}},s=function(e){o.setPath(t._getRectanglePoint(a,e.point))},l=function(){var e=t._calculate(o,o.getPath()[2]);t._dispatchOverlayComplete(o,e),a=null,n.disableEdgeMove(),n.removeEventListener("mousemove",s),i.un(document,"mouseup",l)};n.addEventListener("mousedown",r)},o.prototype._calculate=function(t,e){var n={data:0,label:null};if(this._enableCalculate&&BMapLib.GeoUtils){var i=t.toString();switch(i){case"[object Polyline]":n.data=BMapLib.GeoUtils.getPolylineDistance(t);break;case"[object Polygon]":n.data=BMapLib.GeoUtils.getPolygonArea(t);break;case"[object Circle]":var o=t.getRadius();n.data=Math.PI*o*o}n.data=!n.data||n.data<0?0:n.data.toFixed(2),n.label=this._addLabel(e,n.data)}return n},o.prototype._addGeoUtilsLibrary=function(){if(!BMapLib.GeoUtils){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src","http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils_min.js"),document.body.appendChild(t)}},o.prototype._addLabel=function(t,e){var n=new BMap.Label(e,{position:t});return this._map.addOverlay(n),n},o.prototype._getRectanglePoint=function(t,e){return[new BMap.Point(t.lng,t.lat),new BMap.Point(e.lng,t.lat),new BMap.Point(e.lng,e.lat),new BMap.Point(t.lng,e.lat)]},o.prototype._dispatchOverlayComplete=function(t,e){var n={overlay:t,drawingMode:this._drawingType};e&&(n.calculate=e.data||null,n.label=e.label||null),this.dispatchEvent(this._drawingType+"complete",t),this.dispatchEvent("overlaycomplete",n)},t.prototype=new BMap.Overlay,t.prototype.dispatchEvent=i.lang.Class.prototype.dispatchEvent,t.prototype.addEventListener=i.lang.Class.prototype.addEventListener,t.prototype.removeEventListener=i.lang.Class.prototype.removeEventListener,t.prototype.initialize=function(t){var e=this;this._map=t;var n=this.container=document.createElement("div"),i=this._map.getSize();return n.style.cssText="position:absolute;background:url(about:blank);cursor:crosshair;width:"+i.width+"px;height:"+i.height+"px",this._map.addEventListener("resize",function(t){e._adjustSize(t.size)}),this._map.getPanes().floatPane.appendChild(n),this._bind(),n},t.prototype.draw=function(){var t=this._map,e=t.pixelToPoint(new BMap.Pixel(0,0)),n=t.pointToOverlayPixel(e);this.container.style.left=n.x+"px",this.container.style.top=n.y+"px"},t.prototype.enableEdgeMove=function(){this._enableEdgeMove=!0},t.prototype.disableEdgeMove=function(){clearInterval(this._edgeMoveTimer),this._enableEdgeMove=!1},t.prototype._bind=function(){for(var t=this,e=(this._map,this.container),n=null,o=null,a=function(t){return{x:t.clientX,y:t.clientY}},r=function(e){var r=e.type;e=i.getEvent(e),point=t.getDrawPoint(e);var s=function(){e.point=point,t.dispatchEvent(e)};"mousedown"==r&&(n=a(e));var l=a(e);"click"==r?Math.abs(l.x-n.x)<5&&Math.abs(l.y-n.y)<5&&(o&&Math.abs(l.x-o.x)<5&&Math.abs(l.y-o.y)<5?o=null:(s("click"),o=a(e))):s(r)},s=["click","mousedown","mousemove","mouseup","dblclick"],l=s.length;l--;)i.on(e,s[l],r);i.on(e,"mousemove",function(e){t._enableEdgeMove&&t.mousemoveAction(e)})},t.prototype.mousemoveAction=function(t){function e(t){var e=t.clientX,n=t.clientY;return t.changedTouches&&(e=t.changedTouches[0].clientX,n=t.changedTouches[0].clientY),new BMap.Pixel(e,n)}var n=this._map,i=this,o=n.pointToPixel(this.getDrawPoint(t)),a=e(t),r=a.x-o.x,s=a.y-o.y;o=new BMap.Pixel(a.x-r,a.y-s),this._draggingMovePixel=o;n.pixelToPoint(o);this._panByX=this._panByY=0,o.x<=20||o.x>=n.width-20||o.y<=50||o.y>=n.height-10?(o.x<=20?this._panByX=8:o.x>=n.width-20&&(this._panByX=-8),o.y<=50?this._panByY=8:o.y>=n.height-10&&(this._panByY=-8),this._edgeMoveTimer||(this._edgeMoveTimer=setInterval(function(){n.panBy(i._panByX,i._panByY,{noAnimation:!0})},30))):this._edgeMoveTimer&&(clearInterval(this._edgeMoveTimer),this._edgeMoveTimer=null)},t.prototype._adjustSize=function(t){this.container.style.width=t.width+"px",this.container.style.height=t.height+"px"},t.prototype.getDrawPoint=function(t){var e=this._map,n=i.getTarget(t),o=t.offsetX||t.layerX||0,a=t.offsetY||t.layerY||0;for(1!=n.nodeType&&(n=n.parentNode);n&&n!=e.getContainer();)0==n.clientWidth&&0==n.clientHeight&&n.offsetParent&&"TD"==n.offsetParent.nodeName||(o+=n.offsetLeft||0,a+=n.offsetTop||0),n=n.offsetParent;var r=new BMap.Pixel(o,a),s=e.pixelToPoint(r);return s},e.prototype=new BMap.Control,e.prototype.initialize=function(t){var e=this.container=document.createElement("div");e.className="BMapLib_Drawing";var n=this.panel=document.createElement("div");return n.className="BMapLib_Drawing_panel",this.drawingToolOptions&&this.drawingToolOptions.scale&&this._setScale(this.drawingToolOptions.scale),e.appendChild(n),n.innerHTML=this._generalHtml(),this._bind(n),t.getContainer().appendChild(e),e},e.prototype._generalHtml=function(){var t={};t.hander="拖动地图",t[BMAP_DRAWING_MARKER]="画点",t[BMAP_DRAWING_CIRCLE]="画圆",t[BMAP_DRAWING_POLYLINE]="画折线",t[BMAP_DRAWING_POLYGON]="画多边形",t[BMAP_DRAWING_RECTANGLE]="画矩形";var e=function(e,n){return'<a charIndex="'+i+'" class="'+e+'" drawingType="'+n+'" href="javascript:void(0)" title="'+t[n]+'" onfocus="this.blur()"></a>'},n=[];n.push(e("BMapLib_box BMapLib_hander","hander"));for(var i=0,o=this.drawingModes.length;o>i;i++){var a="BMapLib_box BMapLib_"+this.drawingModes[i];i==o-1&&(a+=" BMapLib_last"),n.push(e(a,this.drawingModes[i]))}return n.join("")},e.prototype._setScale=function(t){var e=390,n=50,i=-parseInt((e-e*t)/2,10),o=-parseInt((n-n*t)/2,10);this.container.style.cssText=["-moz-transform: scale("+t+");","-o-transform: scale("+t+");","-webkit-transform: scale("+t+");","transform: scale("+t+");","margin-left:"+i+"px;","margin-top:"+o+"px;","*margin-left:0px;","*margin-top:0px;","margin-left:0px\\0;","margin-top:0px\\0;","filter: progid:DXImageTransform.Microsoft.Matrix(","M11="+t+",","M12=0,","M21=0,","M22="+t+",","SizingMethod='auto expand');"].join("")},e.prototype._bind=function(){var t=this;i.on(this.panel,"click",function(e){{var n=i.getTarget(e),o=n.getAttribute("drawingType");n.getAttribute("charIndex")}t.setStyleByDrawingMode(o),t._bindEventByDraingMode(o)})},e.prototype.setStyleByDrawingMode=function(t){if(t)for(var e=this.panel.getElementsByTagName("a"),n=0,i=e.length;i>n;n++){var o=e[n];o.getAttribute("charIndex")==t}},e.prototype._bindEventByDraingMode=function(t){var e=this.drawingManager;"hander"==t?(e.close(),e._map.enableDoubleClickZoom()):(e.setDrawingMode(t),e.open(),e._map.disableDoubleClickZoom())};var a=[]}();